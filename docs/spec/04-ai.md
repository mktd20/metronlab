# 04. AI System

모든 AI 기능은 **OpenAI GPT-5-mini**를 사용한다.

## Session Analysis (연습 후 자동 분석)

각 연습 세션 종료 시 JSON 데이터 + **사용자 코멘트**를 GPT-5-mini로 전송.

**분석 항목**:
- BPM 진행 패턴 (점진적 증가 여부)
- 연습 집중도 (일시정지 비율)
- 구간 반복 패턴 (어려운 구간 식별)
- 완주율 추세
- 연습 일관성 (주간/월간)
- **사용자 코멘트 NLP 분석** (감정, 키워드, 약점 추출)
- **코멘트-데이터 교차 검증** (사용자 체감 vs 실제 데이터 비교)

## Periodic Reports (주간/월간 종합 리포트)

- 이메일 발송 (선택적)
- 대시보드 AI Insights 패널에 표시
- 내용:
  - 이번 기간 연습 요약
  - 강점/약점 분석
  - 개선 제안
  - 다음 연습 추천

## Recommendations & Sheet Generation

사용자의 누적 데이터 + 코멘트 히스토리 기반:
- 연습 부족 악기 알림
- 난이도 적정 컨텐츠 추천
- 약점 보완 연습 제안
- 점진적 BPM 증가 플랜
- **맞춤형 악보 실시간 생성** (아래 Dynamic Sheet Generation 참조)
- **코멘트 기반 후속 조언** ("약지가 어려우셨다면 이 워밍업을 추천합니다")

## AI Dynamic Sheet Generation (실시간 악보 생성)

**핵심 개념**: 기존 악보 라이브러리에서 선택하는 것이 아니라, AI가 사용자의 연습 기록과 실력을 분석하여 **그때그때 맞춤형 악보를 새로 생성**한다.

### Generation Flow

1. 사용자가 "AI 생성 연습" 선택 + 악기 선택
2. 시스템이 사용자의 누적 연습 데이터를 수집:
   - 최근 세션 기록 (BPM, 완주율, struggle_points)
   - 사용자 코멘트 히스토리
   - 현재 레벨/역량 추정치
   - 연습 부족 영역 (스케일, 리듬, 테크닉 등)
3. GPT-5-mini에 프롬프트 전송 → 구조화된 악보 JSON 응답
4. 응답 JSON을 Note/Tab 렌더러로 즉시 표시

### AI Prompt Context (API 전송 데이터)

```json
{
  "request_type": "generate_sheet",
  "instrument": "electric_guitar",
  "user_profile": {
    "level": "intermediate",
    "total_practice_hours": 45.2,
    "avg_bpm": 95,
    "max_clean_bpm": 120,
    "strong_areas": ["power_chords", "basic_scales"],
    "weak_areas": ["arpeggio", "alternate_picking", "barre_chords"],
    "preferred_genres": ["rock", "blues"]
  },
  "recent_sessions": [
    {
      "date": "2025-01-14",
      "bpm": 90,
      "completion_rate": 0.72,
      "struggle_points": ["bar 8-12: fast arpeggio"],
      "user_comment": "아르페지오 부분에서 약지가 잘 안 움직임. 느린 템포에서 더 연습해야 할 듯"
    }
  ],
  "generation_params": {
    "difficulty": "adaptive",
    "focus_area": "auto",
    "duration_bars": 16,
    "style": "blues_rock",
    "bpm_suggestion": true
  }
}
```

### AI Response Format (생성된 악보 JSON)

```json
{
  "generated_sheet": {
    "title": "Arpeggio Builder #7 - Am to G Transition",
    "description": "약지 독립성과 아르페지오 전환을 집중 훈련하는 연습곡",
    "difficulty": "intermediate",
    "suggested_bpm": 70,
    "target_bpm": 100,
    "time_signature": "4/4",
    "key": "Am",
    "bars": 16,
    "focus_areas": ["arpeggio", "finger_independence", "chord_transition"],
    "note_data": {
      "measures": [
        {
          "bar": 1,
          "beats": [
            { "pitch": "A3", "duration": "8n", "string": 5, "fret": 0 },
            { "pitch": "E4", "duration": "8n", "string": 4, "fret": 2 },
            { "pitch": "A4", "duration": "8n", "string": 3, "fret": 2 },
            { "pitch": "C5", "duration": "8n", "string": 2, "fret": 1 }
          ]
        }
      ]
    },
    "tab_data": {
      "measures": [
        {
          "bar": 1,
          "strings": {
            "e": ["-", "-", "-", "-", "-", "-", "-", "-"],
            "B": ["-", "-", "-", "1", "-", "-", "-", "1"],
            "G": ["-", "-", "2", "-", "-", "-", "2", "-"],
            "D": ["-", "2", "-", "-", "-", "2", "-", "-"],
            "A": ["0", "-", "-", "-", "0", "-", "-", "-"],
            "E": ["-", "-", "-", "-", "-", "-", "-", "-"]
          }
        }
      ]
    },
    "practice_tips": [
      "처음 4마디는 BPM 70에서 천천히 시작하세요",
      "약지(4번 손가락)가 안정적으로 짚히는지 확인하세요",
      "Am → G 전환 시 2번 손가락을 축으로 사용하세요"
    ],
    "progression_plan": {
      "step1": "BPM 70으로 4마디씩 끊어서 연습",
      "step2": "BPM 70으로 16마디 연속 완주",
      "step3": "BPM 85로 올려서 반복",
      "final_goal": "BPM 100으로 클린 연주"
    }
  }
}
```

### Generation Options

- **난이도 자동 조절**: 사용자 완주율/BPM 기반으로 난이도 자동 결정
- **포커스 영역 자동 선택**: 약점 데이터 기반 집중 영역 결정
- **수동 오버라이드**: 사용자가 원하면 난이도/영역 직접 지정 가능
- **재생성**: "다른 연습 만들어줘" 버튼으로 새 악보 즉시 재생성
- **저장**: 마음에 드는 생성 악보는 개인 라이브러리에 저장 가능

## API Endpoints

```
POST   /api/ai/analyze-session/:id
GET    /api/ai/report?type=weekly
GET    /api/ai/recommendations
POST   /api/ai/generate-sheet
POST   /api/ai/regenerate-sheet/:id
POST   /api/ai/save-sheet/:id
GET    /api/ai/generated-sheets?instrument=guitar&saved=true
```
